import React, { useEffect, useRef } from 'react';

type TapeCassetteProps = {
  enabled: boolean;
  tape: number;
  level?: number;
  className?: string;
};

const MATRIX = 'matrix(1,-1.22465e-16,-1.22465e-16,-1,1.3707,60.5)';
const LEFT_CENTER = { x: 28.4, y: 27.8 };
const RIGHT_CENTER = { x: 65.7, y: 27.8 };

export const TapeCassette: React.FC<TapeCassetteProps> = ({ enabled, tape, level = 0, className }) => {
  const leftRef = useRef<SVGGElement>(null);
  const rightRef = useRef<SVGGElement>(null);
  const enabledRef = useRef(enabled);
  const tapeRef = useRef(tape);
  const levelRef = useRef(level);
  const lastTimeRef = useRef<number | null>(null);
  const angleRef = useRef(0);
  const rafRef = useRef<number | null>(null);

  useEffect(() => {
    enabledRef.current = enabled;
  }, [enabled]);

  useEffect(() => {
    tapeRef.current = tape;
  }, [tape]);

  useEffect(() => {
    levelRef.current = level;
  }, [level]);

  useEffect(() => {
    const step = (time: number) => {
      if (lastTimeRef.current == null) lastTimeRef.current = time;
      const dt = Math.min(0.05, (time - lastTimeRef.current) / 1000);
      lastTimeRef.current = time;

      const base = enabledRef.current ? 0.6 : 0.05;
      const speed = base + tapeRef.current * 1.8 + levelRef.current * 0.8;
      angleRef.current = (angleRef.current + speed * dt * 360) % 360;
      const angle = -angleRef.current;

      if (leftRef.current) {
        leftRef.current.setAttribute('transform', `rotate(${angle} ${LEFT_CENTER.x} ${LEFT_CENTER.y})`);
      }
      if (rightRef.current) {
        rightRef.current.setAttribute('transform', `rotate(${angle} ${RIGHT_CENTER.x} ${RIGHT_CENTER.y})`);
      }

      rafRef.current = requestAnimationFrame(step);
    };

    rafRef.current = requestAnimationFrame(step);
    return () => {
      if (rafRef.current) cancelAnimationFrame(rafRef.current);
    };
  }, []);

  return (
    <svg
      className={className}
      viewBox="0 0 95 60"
      preserveAspectRatio="xMidYMid meet"
      aria-hidden="true"
      fill="none"
      stroke="currentColor"
      strokeWidth="0.2"
      style={{
        fillRule: 'evenodd',
        clipRule: 'evenodd',
        strokeLinejoin: 'round',
        strokeMiterlimit: 2,
      }}
    >
      <g transform={MATRIX}>
        <g ref={rightRef}>
          <path d="M65.7,33.8C69,33.8 71.7,31.2 71.7,27.8C71.7,24.5 69,21.8 65.7,21.8C62.4,21.8 59.7,24.5 59.7,27.8C59.7,31.1 62.4,33.8 65.7,33.8ZM65.7,22.3C68.8,22.3 71.3,24.8 71.3,27.9C71.3,31 68.8,33.5 65.7,33.5C62.6,33.5 60.1,31 60.1,27.9C60.1,24.8 62.6,22.3 65.7,22.3ZM65.7,33.1C68.6,33.1 70.9,30.8 70.9,27.9C70.9,25 68.6,22.7 65.7,22.7C62.8,22.7 60.5,25 60.5,27.9C60.5,30.8 62.8,33.1 65.7,33.1ZM61.974,30.826C61.443,30.176 61.078,29.38 60.95,28.5L61.8,28.5C62,28.5 62.2,28.3 62.2,28.1L62.2,27.7C62.2,27.5 62,27.3 61.8,27.3L60.926,27.3C61.022,26.381 61.381,25.529 61.93,24.83L62.6,25.5C62.7,25.6 63,25.6 63.1,25.5L63.4,25.2C63.5,25.1 63.5,24.8 63.4,24.7L62.729,24.029C63.394,23.503 64.205,23.147 65.1,23.037L65.1,24C65.1,24.2 65.3,24.4 65.5,24.4L65.9,24.4C66.1,24.4 66.3,24.2 66.3,24L66.3,23.037C67.218,23.149 68.057,23.516 68.74,24.06L68.1,24.7C68,24.8 68,25.1 68.1,25.2L68.4,25.5C68.5,25.6 68.8,25.6 68.9,25.5L69.537,24.863C70.058,25.53 70.397,26.333 70.482,27.2L69.7,27.2C69.5,27.2 69.3,27.4 69.3,27.6L69.3,28C69.3,28.2 69.5,28.4 69.7,28.4L70.462,28.4C70.351,29.281 69.999,30.096 69.47,30.77L68.9,30.2C68.8,30.1 68.5,30.1 68.4,30.2L68.1,30.5C68,30.6 68,30.9 68.1,31L68.671,31.571C68.031,32.078 67.256,32.426 66.4,32.55L66.4,31.8C66.4,31.6 66.2,31.4 66,31.4L65.6,31.4C65.4,31.4 65.2,31.6 65.2,31.8L65.2,32.574C64.305,32.48 63.475,32.138 62.787,31.613L63.4,31C63.5,30.9 63.5,30.6 63.4,30.5L63.1,30.2C63,30.1 62.7,30.1 62.6,30.2L61.974,30.826Z" />
        </g>
        <path d="M91.5,38.2L91.2,38.2L91.2,4.1C91.2,3 90.3,2 89.1,2L5,2C3.8,2 2.9,2.9 2.9,4.1L2.9,38.3L2.6,38.3C2.3,38.3 2,38.6 2,38.9L2,53.5C2,53.8 2.3,54 2.6,54L2.9,54L2.9,56.2C2.9,57.3 3.8,58.3 5,58.3L16.4,58.3C16.5,58.7 16.9,59 17.3,59L77.2,59C77.6,59 78,58.7 78.1,58.3L89.2,58.3C90.3,58.3 91.3,57.4 91.3,56.2L91.3,54L91.6,54C91.9,54 92.2,53.7 92.2,53.4L92.2,38.8C92.1,38.5 91.8,38.2 91.5,38.2ZM2.6,53.6C2.5,53.6 2.4,53.5 2.4,53.4L2.4,38.8C2.4,38.7 2.5,38.6 2.6,38.6L2.9,38.6L2.9,53.6L2.6,53.6ZM90.8,56.2C90.8,57.1 90,57.9 89.1,57.9L78.1,57.9L75.1,45.2C75.1,44.7 74.7,44.3 74.2,44.3L20.2,44.3C19.7,44.3 19.3,44.7 19.3,45.2L16.3,57.9L5,57.9C4.1,57.9 3.3,57.1 3.3,56.2L3.3,4.1C3.3,3.1 4,2.4 5,2.4L89.2,2.4C90.1,2.4 90.8,3.2 90.8,4.1L90.8,56.2ZM83.2,43.1C85.4,43.1 87.1,41.4 87.2,39.2L87.2,10.9C87.2,8.7 85.4,6.9 83.2,6.9L11.2,6.9C9,6.9 7.2,8.7 7.2,10.9L7.2,39.1C7.2,41.3 9,43.1 11.2,43.1L83.2,43.1ZM11.2,7.3L83.2,7.3C85.2,7.3 86.8,8.9 86.8,10.9L86.8,39.2C86.8,41.2 85.2,42.8 83.2,42.8L11.2,42.8C9.2,42.8 7.6,41.2 7.6,39.2L7.6,10.9C7.6,8.9 9.2,7.3 11.2,7.3ZM65.7,35.2C69.8,35.2 73.2,31.9 73.2,27.8C73.2,23.7 69.9,20.4 65.8,20.4L28.4,20.4C24.3,20.4 21,23.7 21,27.8C21,31.9 24.3,35.2 28.4,35.2L65.7,35.2ZM28.4,20.9L65.8,20.9C69.7,20.9 72.8,24 72.8,27.9C72.8,31.8 69.7,34.9 65.8,34.9L28.4,34.9C24.5,34.9 21.4,31.8 21.4,27.9C21.4,24 24.5,20.9 28.4,20.9ZM57.3,22.7L36.9,22.7C36.4,22.7 36,23.1 36,23.6L36,32.2C36,32.7 36.4,33.1 36.9,33.1L57.2,33.1C57.8,33.1 58.2,32.7 58.2,32.2L58.2,23.6C58.2,23.1 57.8,22.7 57.3,22.7ZM56.837,32.8L51.7,32.8C52,31.2 52.2,29.5 52.2,27.8C52.2,26.171 52.016,24.541 51.737,23L56.837,23C56.04,24.523 55.6,26.212 55.6,27.9C55.6,29.588 56.04,31.277 56.837,32.8ZM37,32.8L36.9,32.8C36.6,32.8 36.3,32.5 36.3,32.2L36.3,23.6C36.3,23.3 36.6,23 36.9,23L37.124,23C37.946,24.369 38.4,26.085 38.4,27.8C38.4,29.6 37.9,31.3 37,32.8ZM57.241,23L57.3,23C57.6,23 57.9,23.3 57.9,23.6L57.9,32.2C57.9,32.5 57.6,32.8 57.3,32.8L57.241,32.8C56.378,31.325 55.9,29.66 55.9,27.9C55.9,26.14 56.378,24.475 57.241,23ZM5.6,6.5C6.6,6.5 7.3,5.7 7.3,4.8C7.3,3.9 6.6,3.1 5.6,3.1C4.7,3.1 3.9,3.8 3.9,4.8C3.9,5.7 4.6,6.5 5.6,6.5ZM5.6,3.4C6.4,3.4 7,3.9 7,4.7C7,5.5 6.4,6.1 5.6,6.1C4.8,6.1 4.2,5.4 4.2,4.7C4.2,4 4.9,3.4 5.6,3.4ZM5.8,57.1C6.7,57.1 7.5,56.3 7.5,55.4C7.5,54.5 6.8,53.7 5.8,53.7C4.9,53.7 4.1,54.4 4.1,55.4C4.1,56.3 4.8,57.1 5.8,57.1ZM5.8,54C6.5,54 7.2,54.6 7.2,55.4C7.2,56.2 6.5,56.8 5.8,56.8C5,56.8 4.4,56.2 4.4,55.4C4.4,54.6 5.1,54 5.8,54ZM88.3,57.1C89.3,57.1 90.1,56.3 90,55.4C90,54.5 89.3,53.7 88.3,53.7C87.4,53.7 86.6,54.4 86.6,55.4C86.6,56.3 87.3,57.1 88.3,57.1ZM88.3,54C89.1,54 89.7,54.6 89.7,55.4C89.7,56.2 89,56.8 88.3,56.8C87.5,56.8 86.9,56.2 86.9,55.4C86.9,54.6 87.6,54 88.3,54ZM88.5,6.5C89.4,6.5 90.2,5.7 90.2,4.8C90.2,3.9 89.5,3.1 88.5,3.1C87.6,3.1 86.8,3.8 86.8,4.8C86.8,5.7 87.5,6.5 88.5,6.5ZM88.5,3.4C89.2,3.4 89.9,4 89.9,4.8C89.9,5.6 89.2,6.2 88.5,6.2C87.7,6.2 87.1,5.6 87.1,4.8C87.1,4 87.8,3.4 88.5,3.4ZM77.2,58.5L17.2,58.5C16.9,58.5 16.6,58.3 16.6,58L19.6,45.3C19.6,45 19.9,44.7 20.2,44.7L74.1,44.7C74.4,44.7 74.7,45 74.7,45.3L77.7,58.1C77.7,58.3 77.5,58.5 77.2,58.5ZM34.9,55.6C35.8,55.6 36.6,54.8 36.6,53.9C36.6,53 35.9,52.2 34.9,52.2C34,52.2 33.2,53 33.2,53.9C33.2,54.8 33.9,55.6 34.9,55.6ZM34.9,52.5C35.6,52.5 36.3,53.1 36.3,53.9C36.3,54.7 35.6,55.3 34.9,55.3C34.1,55.3 33.5,54.7 33.5,53.9C33.5,53.1 34.2,52.5 34.9,52.5ZM59.5,55.6C60.5,55.6 61.2,54.8 61.2,53.9C61.2,53 60.5,52.2 59.5,52.2C58.6,52.2 57.8,53 57.8,53.9C57.8,54.8 58.5,55.6 59.5,55.6ZM59.5,52.5C60.3,52.5 60.9,53.1 60.9,53.9C60.9,54.7 60.3,55.3 59.5,55.3C58.7,55.3 58.1,54.7 58.1,53.9C58.1,53.1 58.8,52.5 59.5,52.5ZM47.2,51.2C48.4,51.2 49.3,50.2 49.3,49.1C49.3,48 48.4,47 47.2,47C46.1,47 45.1,47.9 45.1,49.1C45.1,50.2 46,51.2 47.2,51.2ZM47.2,47.3C48.2,47.3 48.9,48.1 48.9,49C48.9,49.9 48.2,50.7 47.2,50.7C46.3,50.7 45.5,50 45.5,49C45.5,48.1 46.2,47.3 47.2,47.3ZM25.9,57.5C27.1,57.5 28,56.5 28,55.4C28,54.3 27,53.3 25.9,53.3C24.8,53.3 23.8,54.2 23.8,55.4C23.8,56.5 24.7,57.5 25.9,57.5ZM25.9,53.6C26.9,53.6 27.6,54.4 27.6,55.3C27.6,56.2 26.9,57 25.9,57C25,57 24.2,56.2 24.2,55.3C24.2,54.4 24.9,53.6 25.9,53.6ZM68.5,57.5C69.6,57.5 70.6,56.5 70.6,55.4C70.6,54.3 69.6,53.3 68.5,53.3C67.4,53.3 66.4,54.2 66.4,55.4C66.4,56.5 67.3,57.5 68.5,57.5ZM68.5,53.6C69.4,53.6 70.2,54.4 70.2,55.3C70.2,56.2 69.4,57 68.5,57C67.6,57 66.8,56.2 66.8,55.3C66.8,54.4 67.5,53.6 68.5,53.6ZM91.7,53.5C91.7,53.6 91.6,53.7 91.5,53.7L91.2,53.7L91.2,38.7L91.5,38.7C91.6,38.7 91.7,38.8 91.7,38.9L91.7,53.5Z" />
        <g ref={leftRef}>
          <path d="M28.4,33.8C31.7,33.8 34.3,31.2 34.4,27.8C34.4,24.5 31.7,21.8 28.4,21.8C25.1,21.8 22.4,24.5 22.4,27.8C22.4,31.1 25.1,33.8 28.4,33.8ZM28.4,22.3C31.5,22.3 34,24.8 34,27.9C34,31 31.5,33.5 28.4,33.5C25.3,33.5 22.8,31 22.8,27.9C22.8,24.8 25.3,22.3 28.4,22.3ZM28.4,33.1C31.2,33.1 33.6,30.8 33.6,27.9C33.6,25 31.3,22.7 28.4,22.7C25.5,22.7 23.2,25 23.2,27.9C23.2,30.8 25.5,33.1 28.4,33.1ZM24.629,30.771C24.103,30.106 23.747,29.295 23.637,28.4L24.4,28.4C24.6,28.4 24.8,28.2 24.8,28L24.8,27.6C24.8,27.4 24.6,27.2 24.4,27.2L23.638,27.2C23.746,26.343 24.081,25.549 24.587,24.887L25.2,25.5C25.3,25.6 25.6,25.6 25.7,25.5L26,25.2C26.1,25.1 26.1,24.8 26,24.7L25.374,24.074C26.049,23.523 26.88,23.151 27.8,23.037L27.8,24C27.8,24.2 28,24.4 28.2,24.4L28.6,24.4C28.8,24.4 29,24.2 29,24L29,23.039C29.873,23.154 30.682,23.515 31.352,24.048L30.7,24.7C30.6,24.8 30.6,25.1 30.7,25.2L31,25.5C31.1,25.6 31.4,25.6 31.5,25.5L32.152,24.848C32.705,25.543 33.073,26.388 33.173,27.3L32.3,27.3C32.1,27.3 31.9,27.5 31.9,27.7L31.9,28.1C31.9,28.3 32.1,28.5 32.3,28.5L33.146,28.5C33.014,29.359 32.644,30.152 32.108,30.808L31.5,30.2C31.4,30.1 31.1,30.1 31,30.2L30.7,30.5C30.6,30.6 30.6,30.9 30.7,31L31.296,31.596C30.612,32.125 29.787,32.476 28.9,32.573L28.9,31.8C28.9,31.6 28.7,31.4 28.5,31.4L28.1,31.4C27.9,31.4 27.7,31.6 27.7,31.8L27.7,32.549C26.857,32.424 26.078,32.079 25.43,31.57L26,31C26.1,30.9 26.1,30.6 26,30.5L25.7,30.2C25.6,30.1 25.3,30.1 25.2,30.2L24.629,30.771Z" />
        </g>
      </g>
    </svg>
  );
};
